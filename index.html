<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>霊夢の賽銭ゲーム</title>
  <style>
    body {
      text-align: center;
      background-color: #fffbe6;
      font-family: 'Arial', sans-serif;
    }
    h1 {
      margin-top: 20px;
    }
    #reimu {
      width: 200px;
      margin: 20px auto;
    }
    #saisenbako {
      width: 150px;
      margin: 10px auto;
      position: relative;
    }
    #message {
      margin: 10px;
      font-size: 18px;
      color: #c00;
    }
    #coin-button, #reset-button {
      padding: 15px 30px;
      font-size: 24px;
      margin: 10px;
      background-color: gold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    #coin-count, #cps, #high-score, #timer-display {
      font-size: 16px;
      margin-top: 10px;
    }
    footer {
      margin-top: 40px;
      font-size: 14px;
      color: #666;
    }
    .coin {
      position: absolute;
      width: 20px;
      height: 20px;
      background-color: gold;
      border-radius: 50%;
      opacity: 0;
      animation: throwCoin 1s forwards;
    }
    @keyframes throwCoin {
      0% {
        top: 50px;
        left: 50%;
        transform: translateX(-50%) scale(1);
        opacity: 1;
      }
      50% {
        top: 100px;
        left: 52%;
        transform: translateX(-50%) scale(1.2);
      }
      100% {
        top: 150px;
        left: 50%;
        transform: translateX(-50%) scale(1);
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <h1>霊夢に賽銭を投げよう！</h1>

  <img id="reimu" src="reimu_normal.png" alt="霊夢の表情">
  <br>
  <img id="saisenbako" src="saisen.png" alt="賽銭箱">

  <div id="message">賽銭まだ？</div>
  <button id="coin-button">賽銭を投げる！</button>
  <button id="reset-button">リセット</button>

  <div>
    <label for="timer-select">タイマー: </label>
    <select id="timer-select">
      <option value="0">タイマーなし</option>
      <option value="5">5秒</option>
      <option value="10">10秒</option>
      <option value="60">1分</option>
      <option value="300">5分</option>
    </select>
  </div>

  <div id="coin-count">賽銭の数: 0</div>
  <div id="cps">CPS: 0</div>
  <div id="high-score">ハイスコア: 0</div>
  <div id="timer-display"></div>

  <footer>
    霊夢立ち絵: <a href="https://twitter.com/_Hoshi_Ringo_" target="_blank">星りんご (@_Hoshi_Ringo_)</a>
  </footer>

  <audio id="coin-sound">
    <source src="https://freesound.org/data/previews/341/341695_3248244-lq.mp3" type="audio/mpeg">
  </audio>

  <script>
    const coinButton = document.getElementById("coin-button");
    const resetButton = document.getElementById("reset-button");
    const coinCountDiv = document.getElementById("coin-count");
    const cpsDiv = document.getElementById("cps");
    const highScoreDiv = document.getElementById("high-score");
    const messageDiv = document.getElementById("message");
    const reimuImg = document.getElementById("reimu");
    const saisenBako = document.getElementById("saisenbako");
    const coinSound = document.getElementById("coin-sound");
    const timerSelect = document.getElementById("timer-select");
    const timerDisplay = document.getElementById("timer-display");

    let coinCount = 0;
    let highScore = parseInt(localStorage.getItem("highScore")) || 0;
    let clickTimes = [];
    let lastTouch = 0;
    let timerInterval = null;
    let timeRemaining = 0;
    let timerRunning = false;

    highScoreDiv.textContent = `ハイスコア: ${highScore}`;

    const reimuFaces = {
      normal: "reimu_normal.png",
      happy: "reimu_happy.png",
      excited: "reimu_excited.png",
      angry: "reimu_angry.png"
    };

    const saisenLines = [
      { count: 0, line: "賽銭まだ？", face: "normal" },
      { count: 5, line: "ちょっとは信仰あるのね", face: "happy" },
      { count: 10, line: "いい感じじゃない？", face: "happy" },
      { count: 15, line: "もっと投げてもいいのよ？", face: "happy" },
      { count: 20, line: "ふふっ、調子出てきたわ", face: "excited" },
      { count: 25, line: "毎日来なさい", face: "excited" },
      { count: 30, line: "神社の修理代が捗るわ", face: "happy" },
      { count: 35, line: "まだまだよ", face: "angry" },
      { count: 40, line: "そこまでやるなら巫女になれば？", face: "angry" },
      { count: 45, line: "私に惚れた？…冗談よ", face: "excited" },
      { count: 50, line: "信仰が暴走してるわね", face: "angry" },
      { count: 60, line: "ちょっと真面目に嬉しいかも", face: "happy" },
      { count: 75, line: "もう止まらないわね", face: "excited" },
      { count: 90, line: "あんた霊夢専属信者でしょ", face: "happy" },
      { count: 100, line: "今日の勝者はあなた！", face: "excited" },
      { count: 150, line: "本殿を金ピカにしてやろうかしら", face: "angry" },
      { count: 200, line: "神主にも見せてやりたいわね", face: "excited" },
      { count: 300, line: "これはもう信仰じゃなくて愛ね", face: "happy" },
      { count: 500, line: "あなたが神か…", face: "angry" },
      { count: 1000, line: "信仰の化身。尊敬するわ", face: "angry" }
    ];

    function updateCPS() {
      const now = Date.now();
      clickTimes = clickTimes.filter(t => now - t < 1000);
      cpsDiv.textContent = `CPS: ${clickTimes.length}`;
    }

    function throwCoin() {
      if (!timerRunning) {
        startTimer(parseInt(timerSelect.value));
      }

      if (timerRunning && timeRemaining <= 0) return;

      const now = Date.now();
      clickTimes.push(now);
      updateCPS();

      coinCount++;
      coinSound.currentTime = 0;
      coinSound.play();
      coinCountDiv.textContent = `賽銭の数: ${coinCount}`;

      let selectedLine = saisenLines[0];
      for (let line of saisenLines) {
        if (coinCount >= line.count) selectedLine = line;
        else break;
      }

      messageDiv.textContent = selectedLine.line;
      reimuImg.src = reimuFaces[selectedLine.face];

      const coin = document.createElement("div");
      coin.classList.add("coin");
      saisenBako.appendChild(coin);
      setTimeout(() => coin.remove(), 1000);
    }

    function startTimer(duration) {
      if (timerInterval) clearInterval(timerInterval);
      if (duration <= 0) {
        timerDisplay.textContent = "";
        timerRunning = false;
        return;
      }
      timeRemaining = duration;
      timerRunning = true;
      timerDisplay.textContent = `残り時間: ${timeRemaining}秒`;
      timerInterval = setInterval(() => {
        timeRemaining--;
        timerDisplay.textContent = `残り時間: ${timeRemaining}秒`;
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          coinButton.disabled = true;
          messageDiv.textContent = "時間切れよ";
          reimuImg.src = reimuFaces.angry;
          timerRunning = false;
          updateHighScore();
        }
      }, 1000);
    }

    function resetGame() {
      coinCount = 0;
      clickTimes = [];
      coinCountDiv.textContent = "賽銭の数: 0";
      cpsDiv.textContent = "CPS: 0";
      messageDiv.textContent = "賽銭まだ？";
      reimuImg.src = reimuFaces.normal;
      coinButton.disabled = false;

      // タイマーもリセット
      let selectedTime = parseInt(timerSelect.value);
      startTimer(selectedTime);
    }

    function updateHighScore() {
      if (coinCount > highScore) {
        highScore = coinCount;
        localStorage.setItem("highScore", highScore);
        highScoreDiv.textContent = `ハイスコア: ${highScore}`;
      }
    }

    coinButton.addEventListener("click", throwCoin);
    coinButton.addEventListener("touchstart", (e) => {
      e.preventDefault();
      if (Date.now() - lastTouch > 500) {
        lastTouch = Date.now();
        throwCoin();
      }
    });

    resetButton.addEventListener("click", resetGame);
    setInterval(updateCPS, 200);

    // 初期化
    resetGame();
  </script>
</body>
</html>
